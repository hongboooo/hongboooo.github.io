---
import papersRaw from '../data/papers.yaml';
const papers = papersRaw as any[];
const featured = papers.filter((p: any) => p.featured);

const venueColorMap: Record<string, string> = {
  conference: '#3D78F5',
  journal: '#10B981',
  workshop: '#F59E0B',
};
---

<section class="container-page py-20" data-animate>
  <!-- Header -->
  <div class="flex items-center justify-between mb-10">
    <div>
      <h2 class="font-heading text-2xl md:text-3xl font-bold tracking-tight">
        Selected Publications
      </h2>
    </div>
    <div class="flex items-center gap-3">
      <!-- Nav arrows -->
      <button
        id="carousel-prev"
        class="w-10 h-10 rounded-full border border-subtle flex items-center justify-center text-muted hover:text-accent hover:border-accent/40 transition-all duration-200 disabled:opacity-30 disabled:cursor-not-allowed"
        aria-label="Previous"
      >
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button
        id="carousel-next"
        class="w-10 h-10 rounded-full border border-subtle flex items-center justify-center text-muted hover:text-accent hover:border-accent/40 transition-all duration-200 disabled:opacity-30 disabled:cursor-not-allowed"
        aria-label="Next"
      >
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <a href="/publications" class="hidden sm:inline-flex text-sm font-medium text-accent hover:text-accent-dark transition-colors ml-2">
        View all â†’
      </a>
    </div>
  </div>

  <!-- Carousel track -->
  <div
    id="carousel-track"
    class="flex gap-5 overflow-x-auto scroll-smooth pb-4 -mb-4"
    style="scrollbar-width: none; -ms-overflow-style: none;"
  >
    {featured.map((paper: any, i: number) => (
      <a
        href={paper.doi || '/publications'}
        target={paper.doi ? '_blank' : '_self'}
        rel={paper.doi ? 'noopener' : undefined}
        class="carousel-card group flex-shrink-0 w-[300px] sm:w-[340px] rounded-2xl border border-subtle bg-[var(--bg-primary)] overflow-hidden transition-all duration-500 hover:border-accent/30 hover:shadow-xl hover:shadow-accent/5"
        style={`scroll-snap-align: start; --delay: ${i * 60}ms;`}
      >
        {/* Image */}
        {paper.image && (
          <div class="w-full h-44 overflow-hidden bg-[var(--bg-alt)] relative">
            <img
              src={paper.image}
              alt={paper.title}
              class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-110"
              loading="lazy"
            />
            {/* Gradient overlay */}
            <div class="absolute inset-0 bg-gradient-to-t from-black/20 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500" />
          </div>
        )}
        {/* Content */}
        <div class="p-4 space-y-2.5">
          <div class="flex items-center gap-2">
            <span
              class="px-2 py-0.5 rounded text-xs font-semibold text-white"
              style={`background-color: ${venueColorMap[paper.venue.type] || '#3D78F5'};`}
            >
              {paper.venue.short} '{String(paper.year).slice(-2)}
            </span>
            {paper.award && (
              <span class="text-xs">{'\u{1F3C6}'}</span>
            )}
          </div>
          <h3 class="carousel-title font-heading font-semibold text-[15px] leading-snug group-hover:text-accent transition-colors duration-300">
            {paper.title}
          </h3>
        </div>
      </a>
    ))}
  </div>

  <!-- Scroll progress indicator -->
  <div class="mt-6 flex items-center gap-3">
    <div class="flex-1 h-0.5 bg-[var(--border-color)] rounded-full overflow-hidden">
      <div id="carousel-progress" class="h-full bg-accent rounded-full transition-all duration-300 ease-out" style="width: 0%;" />
    </div>
  </div>
</section>

<style>
  #carousel-track::-webkit-scrollbar {
    display: none;
  }
  #carousel-track {
    scroll-snap-type: x mandatory;
  }
  .carousel-title {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .carousel-card:hover .carousel-title {
    -webkit-line-clamp: unset;
    display: block;
  }
</style>

<script>
  const track = document.getElementById('carousel-track');
  const prevBtn = document.getElementById('carousel-prev');
  const nextBtn = document.getElementById('carousel-next');
  const progress = document.getElementById('carousel-progress');

  if (track && prevBtn && nextBtn && progress) {
    const cardWidth = 360; // card width + gap

    const updateProgress = () => {
      const maxScroll = track.scrollWidth - track.clientWidth;
      const pct = maxScroll > 0 ? (track.scrollLeft / maxScroll) * 100 : 0;
      progress.style.width = `${Math.max(10, pct)}%`;
      // Update button states
      (prevBtn as HTMLButtonElement).disabled = track.scrollLeft < 10;
      (nextBtn as HTMLButtonElement).disabled = track.scrollLeft >= maxScroll - 10;
    };

    prevBtn.addEventListener('click', () => {
      track.scrollBy({ left: -cardWidth, behavior: 'smooth' });
    });

    nextBtn.addEventListener('click', () => {
      track.scrollBy({ left: cardWidth, behavior: 'smooth' });
    });

    track.addEventListener('scroll', updateProgress, { passive: true });
    updateProgress();

    // Keyboard support
    track.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'ArrowLeft') track.scrollBy({ left: -cardWidth, behavior: 'smooth' });
      if (e.key === 'ArrowRight') track.scrollBy({ left: cardWidth, behavior: 'smooth' });
    });
  }
</script>
